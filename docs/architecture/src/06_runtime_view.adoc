ifndef::imagesdir[:imagesdir: ../images]

[[section-runtime-view]]
== Runtime View

This section describes the behavior of the `headsetcontrol-tray` application at runtime.

=== User Changes Equalizer Preset

The following sequence diagram shows a typical user interaction: changing the equalizer preset.

[mermaid, target="runtime-sequence", format="svg"]
....
sequenceDiagram
    participant User
    participant SystemTrayIcon
    participant SettingsDialog
    participant HeadsetService
    participant HIDManager
    participant Headset

    User->>SystemTrayIcon: Clicks "Settings"
    SystemTrayIcon->>SettingsDialog: Shows dialog
    User->>SettingsDialog: Selects new equalizer preset
    SettingsDialog->>HeadsetService: set_equalizer_preset(preset)
    HeadsetService->>HIDManager: send_command(command)
    HIDManager->>Headset: Writes HID report
    Headset-->>HIDManager: Returns status
    HIDManager-->>HeadsetService: Returns status
    HeadsetService-->>SettingsDialog: Updates UI
....

This diagram illustrates the flow of control when a user changes the equalizer preset. The user interacts with the `SettingsDialog`, which in turn calls the `HeadsetService` to apply the change. The `HeadsetService` then uses the `HIDManager` to send the command to the headset. The response from the headset is propagated back up the call stack, and the UI is updated to reflect the new state.

=== Application Startup

When the application starts, the following sequence of events occurs:

1.  The `App` class is instantiated.
2.  The `ConfigManager` is initialized, and the user's settings are loaded.
3.  The `OSLayer` is instantiated for the current operating system.
4.  The `HIDManager` is initialized, and it starts scanning for connected headsets.
5.  The `HeadsetService` is initialized.
6.  The `SystemTrayIcon` is created and displayed.
7.  If a headset is detected, the `HeadsetService` establishes a connection and retrieves the current status.
8.  The `SystemTrayIcon` is updated with the headset's status.

The application then enters the main event loop and waits for user interaction.
